<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geffen Cockpit Dashboard</title>
  <style>
    :root{
      /* Futuristic blue + metallic (FF7-ish mako + steel) */
      --bg0:#070B1A;
      --bg1:#0B1230;
      --panel:#0C1638;
      --panel2:#0A1230;

      --ink:#EAF0FF;
      --muted:#B7C2E6;

      --electric:#2D7DFF;
      --electric2:#1E5BFF;
      --cyan:#7BE7FF;

      --mako:#4BFFD3;
      --brass:#D7B56D;
      --brass2:#8A6B2F;
      --steel:#9AA7C1;
      --steel2:#6D7A96;

      --gold:#FFE066;
      --red:#FF5A5A;
      --warn:#FFB55A;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 28px rgba(0,0,0,.35);

      --radius: 18px;
      --radius2: 26px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";

      --ringSize: 520px;      /* auto-updated by JS */
      --centerBoxW: 270px;    /* center block */
      --centerBoxH: 230px;

      --pillBg: rgba(234,240,255,.06);
      --pillBd: rgba(123,231,255,.22);
      --pillBd2: rgba(45,125,255,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--ink);
      background: radial-gradient(1200px 700px at 20% 15%, rgba(45,125,255,.14), transparent 55%),
                  radial-gradient(1000px 650px at 80% 30%, rgba(75,255,211,.10), transparent 55%),
                  radial-gradient(900px 600px at 50% 85%, rgba(215,181,109,.08), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* STARFIELD */
    .fxLayer{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:0;
    }
    canvas.fx{ position:absolute; inset:0; width:100%; height:100%; opacity:.65; }
    canvas.arcs{ mix-blend-mode: screen; opacity:.9; }

    /* LAYOUT */
    .wrap{
      position:relative;
      z-index:1;
      height:100%;
      display:grid;
      grid-template-columns: minmax(340px, 1.15fr) minmax(320px, 0.95fr);
      gap:16px;
      padding:16px;
    }

    .left, .right{
      background: linear-gradient(180deg, rgba(12,22,56,.92), rgba(10,18,48,.88));
      border: 1px solid rgba(123,231,255,.14);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .left{ display:flex; flex-direction:column; }
    .right{ display:flex; flex-direction:column; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom: 1px solid rgba(123,231,255,.12);
      background: linear-gradient(180deg, rgba(7,11,26,.45), rgba(7,11,26,.12));
    }

    .brand{
      display:flex; align-items:baseline; gap:10px;
      letter-spacing:.5px;
      user-select:none;
    }
    .brand .title{
      font-weight:750;
      font-size:16px;
    }
    .brand .sub{
      font-size:12px;
      color: var(--muted);
      opacity:.9;
    }

    .topRight{
      display:flex; align-items:center; gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: var(--pillBg);
      border: 1px solid var(--pillBd);
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
      color: var(--ink);
      font-size:12px;
      line-height:1;
      white-space:nowrap;
    }
    .pill strong{ font-weight:800; letter-spacing:.3px; }
    .pill .muted{ color:var(--muted); opacity:.9; }

    .btn{
      cursor:pointer;
      border:none;
      border-radius: 12px;
      padding:10px 12px;
      background: linear-gradient(180deg, rgba(45,125,255,.18), rgba(45,125,255,.08));
      border: 1px solid rgba(45,125,255,.35);
      color: var(--ink);
      font-weight:650;
      letter-spacing:.2px;
      box-shadow: var(--shadow2);
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(123,231,255,.45); }
    .btn:active{ transform: translateY(0px); }

    .btn.ghost{
      background: rgba(234,240,255,.06);
      border: 1px solid rgba(123,231,255,.18);
      color: var(--muted);
      font-weight:650;
    }
    .btn.warn{
      background: rgba(255,181,90,.10);
      border: 1px solid rgba(255,181,90,.35);
    }
    .btn.danger{
      background: rgba(255,90,90,.10);
      border: 1px solid rgba(255,90,90,.35);
    }

    /* LEFT CONTENT */
    .leftBody{
      display:grid;
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr;
      height:100%;
      position:relative;
    }

    .searchRow{
      padding:12px 14px;
      border-bottom: 1px solid rgba(123,231,255,.10);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .searchWrap{
      flex:1;
      position:relative;
      display:flex;
      align-items:center;
    }
    .search{
      width:100%;
      background: rgba(7,11,26,.35);
      border: 1px solid rgba(123,231,255,.18);
      border-radius: 14px;
      padding:12px 12px 12px 40px;
      color: var(--ink);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.05);
    }
    .search::placeholder{ color: rgba(183,194,230,.72); }
    .searchIcon{
      position:absolute;
      left:12px;
      width:18px; height:18px;
      opacity:.85;
      color: var(--cyan);
      filter: drop-shadow(0 0 10px rgba(123,231,255,.25));
      pointer-events:none;
      font-family: var(--mono);
    }

    .ringZone{
      position:relative;
      padding:14px;
      display:grid;
      place-items:center;
      overflow:hidden;
      min-height: 520px;
    }

    .ringFrame{
      width:min(100%, 720px);
      height:min(100%, 720px);
      aspect-ratio: 1 / 1;
      position:relative;
      border-radius: 28px;
      border: 1px solid rgba(123,231,255,.14);
      background: radial-gradient(closest-side, rgba(12,22,56,.70), rgba(7,11,26,.10) 62%, rgba(7,11,26,.02));
      box-shadow: var(--shadow2);
      overflow:hidden;
    }

    .ringCanvas{
      position:absolute;
      inset: 10px;
      border-radius: 24px;
      border: 1px solid rgba(123,231,255,.10);
      background: radial-gradient(closest-side, rgba(7,11,26,.32), rgba(7,11,26,.06) 70%);
    }

    .ring{
      position:absolute;
      inset: 18px;
      border-radius: 999px;
      border: 1px solid rgba(123,231,255,.16);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
      background: radial-gradient(closest-side, rgba(7,11,26,.05), rgba(7,11,26,.0) 70%);
    }

    /* tiny periodic arcs on ring frame */
    .ringFrame:before{
      content:"";
      position:absolute; inset:0;
      border-radius: 28px;
      pointer-events:none;
      background: radial-gradient(650px 220px at 50% -10%, rgba(45,125,255,.25), transparent 60%),
                  radial-gradient(500px 200px at 120% 40%, rgba(123,231,255,.18), transparent 55%),
                  radial-gradient(500px 200px at -20% 60%, rgba(75,255,211,.12), transparent 55%);
      opacity:.55;
      mix-blend-mode: screen;
    }

    .centerBox{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width: var(--centerBoxW);
      height: var(--centerBoxH);
      border-radius: 20px;
      border: 1px solid rgba(123,231,255,.18);
      background: linear-gradient(180deg, rgba(7,11,26,.65), rgba(12,22,56,.60));
      box-shadow: var(--shadow2);
      padding:12px 12px 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
      z-index:4;
    }

    .centerTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .clockWrap{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 140px;
    }
    .clock{
      font-family: var(--mono);
      font-weight:800;
      letter-spacing:.6px;
      font-size:18px;
      line-height:1.1;
    }
    .dateLine{
      color: var(--muted);
      font-size:12px;
    }

    .nextClass{
      margin-top:6px;
      font-size:12px;
      color: var(--muted);
      line-height:1.2;
      padding:7px 10px;
      border-radius: 14px;
      border: 1px solid rgba(123,231,255,.14);
      background: rgba(234,240,255,.05);
    }
    .nextClass strong{ color: var(--ink); }
    .nextClass.hot{
      border-color: rgba(45,125,255,.55);
      box-shadow: 0 0 0 1px rgba(45,125,255,.18), 0 0 18px rgba(45,125,255,.22);
      color: rgba(234,240,255,.95);
    }

    .scheduleMini{
      flex:1;
      border-radius: 16px;
      border: 1px solid rgba(123,231,255,.12);
      background: rgba(7,11,26,.32);
      padding:10px 10px;
      overflow:auto;
    }
    .schedLine{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:5px 0;
      border-bottom: 1px dashed rgba(123,231,255,.10);
      font-size:12px;
    }
    .schedLine:last-child{ border-bottom:none; }
    .schedLine .t{ font-family: var(--mono); color: var(--muted); min-width:68px; }
    .schedLine .n{ flex:1; }
    .schedLine.named .n{
      color: var(--mako);
      font-weight:800;
      text-shadow: 0 0 10px rgba(75,255,211,.18);
    }

    /* Ring nodes */
    .node{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width: 88px;
      height: 88px;
      border-radius: 999px;
      border: 1px solid rgba(123,231,255,.22);
      background: radial-gradient(closest-side, rgba(45,125,255,.18), rgba(7,11,26,.28) 62%, rgba(7,11,26,.12));
      box-shadow: 0 16px 30px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
      cursor:pointer;
      user-select:none;
      overflow:hidden;
      z-index:3;
      transition: transform .12s ease, border-color .16s ease;
    }
    .node:hover{ border-color: rgba(123,231,255,.45); transform: translate(-50%,-50%) scale(1.03); }
    .node .label{
      text-align:center;
      font-size:12px;
      font-weight:750;
      line-height:1.1;
      padding:2px 3px;
      text-shadow: 0 0 14px rgba(45,125,255,.25);
    }
    .node .sub{
      display:block;
      margin-top:4px;
      font-size:10px;
      color: var(--muted);
      font-weight:650;
    }

    /* Node context menu */
    .ctx{
      position:fixed;
      min-width: 240px;
      background: linear-gradient(180deg, rgba(12,22,56,.96), rgba(7,11,26,.92));
      border: 1px solid rgba(123,231,255,.20);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding:10px;
      z-index:999;
      display:none;
    }
    .ctx.on{ display:block; }
    .ctx h4{
      margin:0 0 8px;
      font-size:12px;
      color: var(--muted);
      letter-spacing:.25px;
    }
    .ctx .row{ display:flex; gap:8px; margin:8px 0; }
    .ctx input{
      width:100%;
      background: rgba(7,11,26,.35);
      border: 1px solid rgba(123,231,255,.16);
      border-radius: 12px;
      padding:10px;
      color: var(--ink);
      outline:none;
      font-family: var(--sans);
      font-size:12px;
    }
    .ctx input::placeholder{ color: rgba(183,194,230,.7); }
    .ctx .row .btn{ flex:1; padding:10px 10px; border-radius: 12px; font-size:12px; }
    .ctx .miniHelp{
      font-size:11px;
      color: rgba(183,194,230,.85);
      line-height:1.25;
      margin-top:6px;
    }

    /* RIGHT PANEL */
    .right .topbar{
      border-bottom: 1px solid rgba(123,231,255,.12);
    }
    .rightBody{
      display:flex;
      flex-direction:column;
      height:100%;
      overflow:hidden;
    }

    .tabs{
      display:flex;
      gap:8px;
      padding:12px 14px 0;
      flex-wrap:wrap;
    }
    .tab{
      cursor:pointer;
      padding:9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(123,231,255,.16);
      background: rgba(234,240,255,.05);
      color: var(--muted);
      font-size:12px;
      font-weight:750;
      user-select:none;
    }
    .tab.on{
      color: var(--ink);
      border-color: rgba(45,125,255,.45);
      background: rgba(45,125,255,.12);
      box-shadow: 0 0 0 1px rgba(45,125,255,.10);
    }

    .panel{
      padding:12px 14px 14px;
      overflow:auto;
      flex:1;
    }

    .sectionTitle{
      font-size:12px;
      color: var(--muted);
      letter-spacing:.3px;
      margin:10px 0 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .item{
      border-radius: 18px;
      border: 1px solid rgba(123,231,255,.14);
      background: rgba(7,11,26,.25);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      padding:10px 10px;
    }

    .itemTop{
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .chk{
      width:18px; height:18px;
      border-radius: 6px;
      border: 1px solid rgba(123,231,255,.22);
      background: rgba(234,240,255,.03);
      cursor:pointer;
      display:grid; place-items:center;
      margin-top:2px;
      flex:0 0 auto;
    }
    .chk.on{
      border-color: rgba(75,255,211,.45);
      box-shadow: 0 0 0 1px rgba(75,255,211,.10), 0 0 14px rgba(75,255,211,.14);
    }
    .chk svg{ opacity:.0; }
    .chk.on svg{ opacity:1; }

    .txtWrap{ flex:1; min-width:0; }
    .txt{
      font-size:13px;
      line-height:1.2;
      font-weight:650;
      word-break: break-word;
    }
    .txt.done{
      opacity:.65;
      text-decoration: line-through;
      text-decoration-thickness: 2px;
    }

    .metaRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color: var(--muted);
      padding:7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(123,231,255,.14);
      background: rgba(234,240,255,.04);
      user-select:none;
    }
    .chip b{ color: var(--ink); font-weight:850; }
    .chip.hot{ border-color: rgba(255,181,90,.30); }
    .chip.due{ border-color: rgba(45,125,255,.35); }
    .chip.pri1{ border-color: rgba(255,90,90,.33); }
    .chip.pri2{ border-color: rgba(255,181,90,.32); }
    .chip.pri3{ border-color: rgba(123,231,255,.16); }

    .controls{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:8px;
    }
    .controls .btn{
      padding:10px 10px;
      border-radius: 14px;
      font-size:12px;
      box-shadow:none;
    }

    .addRow{
      display:flex;
      gap:8px;
      margin-top:10px;
      align-items:center;
    }
    .addRow input{
      flex:1;
      background: rgba(7,11,26,.35);
      border: 1px solid rgba(123,231,255,.16);
      border-radius: 14px;
      padding:12px 12px;
      color: var(--ink);
      outline:none;
      font-size:13px;
    }
    .addRow input::placeholder{ color: rgba(183,194,230,.70); }

    .small{
      font-size:11px;
      color: rgba(183,194,230,.85);
      line-height:1.25;
      margin-top:8px;
    }

    /* CALENDAR DRAWER */
    .drawer{
      position:fixed;
      right: 16px;
      top: 16px;
      height: calc(100% - 32px);
      width: min(460px, calc(100% - 32px));
      background: linear-gradient(180deg, rgba(12,22,56,.98), rgba(7,11,26,.96));
      border: 1px solid rgba(123,231,255,.20);
      border-radius: 26px;
      box-shadow: var(--shadow);
      z-index:1000;
      transform: translateX(calc(100% + 18px));
      transition: transform .20s ease;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .drawer.on{ transform: translateX(0); }

    .drawerHead{
      padding:12px 14px;
      border-bottom: 1px solid rgba(123,231,255,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(7,11,26,.45), rgba(7,11,26,.12));
    }
    .drawerHead .h{
      font-size:13px;
      font-weight:850;
      letter-spacing:.25px;
    }
    .drawerBody{
      padding:12px 14px 14px;
      overflow:auto;
      flex:1;
    }
    .drawerGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .field{
      border-radius: 18px;
      border: 1px solid rgba(123,231,255,.14);
      background: rgba(7,11,26,.25);
      padding:10px;
    }
    .field label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:11px;
      color: rgba(183,194,230,.90);
      margin-bottom:8px;
      letter-spacing:.25px;
    }
    .field input[type="date"], .field textarea{
      width:100%;
      background: rgba(7,11,26,.35);
      border: 1px solid rgba(123,231,255,.16);
      border-radius: 14px;
      padding:10px 12px;
      color: var(--ink);
      outline:none;
      font-size:13px;
      font-family: var(--sans);
    }
    .field textarea{
      min-height: 160px;
      resize: vertical;
      line-height:1.25;
    }
    .drawerFoot{
      padding:12px 14px;
      border-top: 1px solid rgba(123,231,255,.12);
      display:flex;
      gap:10px;
    }
    .drawerFoot .btn{ flex:1; }

    /* TOAST */
    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform: translate(-50%, 120%);
      background: linear-gradient(180deg, rgba(12,22,56,.96), rgba(7,11,26,.92));
      border: 1px solid rgba(123,231,255,.22);
      border-radius: 999px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow: var(--shadow);
      z-index:1100;
      transition: transform .18s ease;
      max-width: calc(100% - 24px);
    }
    .toast.on{ transform: translate(-50%, 0); }
    .toast .msg{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 68vw;
    }
    .toast .btn{ padding:8px 10px; border-radius: 999px; font-size:12px; box-shadow:none; }
    .flash{
      animation: flash 0.55s ease;
    }
    @keyframes flash{
      0%{ box-shadow: 0 0 0 0 rgba(75,255,211,.0); }
      20%{ box-shadow: 0 0 0 3px rgba(75,255,211,.18), 0 0 22px rgba(45,125,255,.18); }
      100%{ box-shadow: 0 0 0 0 rgba(75,255,211,.0); }
    }

    /* Responsive */
    @media (max-width: 980px){
      body{ overflow:auto; }
      .wrap{
        height:auto;
        grid-template-columns: 1fr;
      }
      .ringZone{ min-height: 520px; }
    }
  </style>
</head>
<body>

  <!-- FX -->
  <div class="fxLayer">
    <canvas id="stars" class="fx"></canvas>
    <canvas id="arcs" class="fx arcs"></canvas>
  </div>

  <div class="wrap">
    <!-- LEFT -->
    <section class="left">
      <div class="topbar">
        <div class="brand">
          <div class="title">Geffen Cockpit</div>
          <div class="sub">calendar + ring + checklist</div>
        </div>

        <div class="topRight">
          <div class="pill" id="pillClock">
            <strong id="pillTime">--:--</strong>
            <span class="muted" id="pillDow">---</span>
          </div>
          <button class="btn ghost" id="openDrawerBtn">Calendar</button>
          <button class="btn ghost" id="editLinksBtn">Edit Links</button>
        </div>
      </div>

      <div class="leftBody">
        <div class="searchRow">
          <div class="searchWrap">
            <div class="searchIcon">⌕</div>
            <input id="googleQuery" class="search" placeholder="Search (press Enter)…" />
          </div>
          <button class="btn" id="goSearchBtn">Go</button>
        </div>

        <div class="ringZone">
          <div class="ringFrame" id="ringFrame">
            <div class="ringCanvas"></div>
            <div class="ring" id="ring"></div>

            <!-- Center module -->
            <div class="centerBox" id="centerBox">
              <div class="centerTop">
                <div class="clockWrap">
                  <div class="clock" id="clockText">--:--:--</div>
                  <div class="dateLine" id="dateText">---</div>
                  <div class="nextClass" id="nextClassBox">
                    <div><strong id="nextClassName">Next:</strong> <span id="nextClassWhen">--</span></div>
                    <div class="muted" id="untilLine">Time until next class: --</div>
                  </div>
                </div>
                <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                  <div class="pill" id="pillViewDate">
                    <span class="muted">Viewing</span>
                    <strong id="viewDateLabel">----</strong>
                  </div>
                  <button class="btn ghost" id="todayBtn">Today</button>
                </div>
              </div>

              <div class="scheduleMini" id="miniSchedule"></div>
            </div>
          </div>

          <!-- Node context menu -->
          <div class="ctx" id="ctxMenu">
            <h4 id="ctxTitle">Edit link</h4>
            <div class="row">
              <input id="ctxLabel" placeholder="Label (short)" />
            </div>
            <div class="row">
              <input id="ctxUrl" placeholder="URL (https://…)" />
            </div>
            <div class="row">
              <button class="btn" id="ctxSave">Save</button>
              <button class="btn danger" id="ctxDelete">Delete</button>
            </div>
            <div class="row">
              <button class="btn ghost" id="ctxCancel">Close</button>
              <button class="btn ghost" id="ctxAdd">Add new</button>
            </div>
            <div class="miniHelp">Tip: right-click a node to edit. Drag nodes to reorder when “Edit Links” is on.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="right">
      <div class="topbar">
        <div class="brand">
          <div class="title">Checklist</div>
          <div class="sub" id="checklistSub">today</div>
        </div>
        <div class="topRight">
          <button class="btn ghost" id="clearDoneBtn">Clear done</button>
          <button class="btn warn" id="undoBtn">Undo</button>
        </div>
      </div>

      <div class="rightBody">
        <div class="tabs">
          <div class="tab on" data-tab="checklist">Checklist</div>
          <div class="tab" data-tab="week">Week</div>
          <div class="tab" data-tab="setup">Setup</div>
        </div>

        <div class="panel" id="panelChecklist">
          <div class="sectionTitle">
            <span>Items</span>
            <span class="muted" id="countLine">0</span>
          </div>
          <div class="list" id="checkList"></div>

          <div class="addRow">
            <input id="newItemText" placeholder="Add an item…" />
            <button class="btn" id="addItemBtn">Add</button>
          </div>
          <div class="small">Quick keys: Enter adds. Click priority/due/note on an item to set details.</div>
        </div>

        <div class="panel" id="panelWeek" style="display:none;">
          <div class="sectionTitle">
            <span>This week’s tasks</span>
            <button class="btn ghost" id="syncWeekFromScheduleBtn">Auto from schedule</button>
          </div>
          <div class="list" id="weekTasks"></div>
          <div class="small">This is lightweight: it shows what you’ve written into the Calendar drawer for each day.</div>
        </div>

        <div class="panel" id="panelSetup" style="display:none;">
          <div class="sectionTitle"><span>Daily schedule template</span></div>
          <div class="field">
            <label>
              <span>Named periods (comma-separated)</span>
              <span class="muted">highlights in center</span>
            </label>
            <input id="namedPeriods" placeholder="B1, B2, Office Hours, Advisory…" />
          </div>
          <div class="field" style="margin-top:12px;">
            <label><span>Default schedule lines</span><span class="muted">one per line: 08:30 | B1</span></label>
            <textarea id="defaultSchedule" placeholder="08:30 | B1&#10;09:45 | B2&#10;11:00 | Prep&#10;…"></textarea>
          </div>
          <div class="addRow" style="margin-top:12px;">
            <button class="btn" id="saveSetupBtn">Save setup</button>
            <button class="btn ghost" id="resetSetupBtn">Reset</button>
          </div>
          <div class="small">Your daily schedule for a specific date can override this template via the Calendar drawer.</div>
        </div>
      </div>
    </section>
  </div>

  <!-- CALENDAR DRAWER -->
  <aside class="drawer" id="drawer">
    <div class="drawerHead">
      <div class="h">Calendar drawer</div>
      <button class="btn ghost" id="closeDrawerBtn">Close</button>
    </div>
    <div class="drawerBody">
      <div class="drawerGrid">
        <div class="field">
          <label>
            <span>Date</span>
            <span class="muted">switch what you’re viewing</span>
          </label>
          <input type="date" id="viewDate" />
          <div class="small">This updates the center schedule and the checklist on the right.</div>
        </div>

        <div class="field">
          <label>
            <span>Schedule for this date</span>
            <span class="muted">optional override</span>
          </label>
          <textarea id="scheduleText" placeholder="08:30 | B1&#10;09:45 | B2&#10;11:00 | Prep&#10;…"></textarea>
          <div class="small">If left blank, the default schedule template is used.</div>
        </div>

        <div class="field">
          <label>
            <span>Notes for this date</span>
            <span class="muted">anything</span>
          </label>
          <textarea id="dayNotes" placeholder="Parent conferences, copies, email admin, etc…"></textarea>
        </div>
      </div>
    </div>
    <div class="drawerFoot">
      <button class="btn" id="saveDayBtn">Save day</button>
      <button class="btn ghost" id="clearDayBtn">Clear override</button>
    </div>
  </aside>

  <!-- TOAST -->
  <div class="toast" id="toast">
    <div class="msg" id="toastMsg">Saved.</div>
    <button class="btn" id="toastUndo">Undo</button>
    <button class="btn ghost" id="toastClose">Close</button>
  </div>

  <script>
    /************************************************************
     * STATE
     ************************************************************/
    const LS_KEY = "geffen_cockpit_v5";
    const nowISO = () => new Date().toISOString();

    const defaultState = {
      viewDate: new Date().toISOString().slice(0,10),

      // Ring links
      links: [
        { id: uid(), label:"Google Classroom", url:"https://classroom.google.com" },
        { id: uid(), label:"Gmail",            url:"https://mail.google.com" },
        { id: uid(), label:"Calendar",         url:"https://calendar.google.com" },
        { id: uid(), label:"Drive",            url:"https://drive.google.com" },
        { id: uid(), label:"Geffen",           url:"https://www.geffenacademy.ucla.edu/" },
        { id: uid(), label:"Canvas",           url:"https://canvas.instructure.com/" }
      ],

      // per-day data
      days: {
        // "YYYY-MM-DD": { scheduleOverride:"", notes:"", checklist:[...] }
      },

      // setup
      namedPeriods: ["B1","B2","B3","B4","Advisory","Office Hours","Prep"],
      defaultScheduleLines: [
        "08:30 | B1",
        "09:45 | B2",
        "11:00 | Office Hours",
        "11:40 | B3",
        "12:55 | B4",
        "14:10 | Prep"
      ],

      // UI flags
      editLinks: false
    };

    let state = loadState();

    function uid(){
      return Math.random().toString(16).slice(2) + "-" + Math.random().toString(16).slice(2);
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return JSON.parse(JSON.stringify(defaultState));
        const parsed = JSON.parse(raw);
        // soft-merge for forward compatibility
        return {
          ...JSON.parse(JSON.stringify(defaultState)),
          ...parsed,
          links: Array.isArray(parsed.links) && parsed.links.length ? parsed.links : defaultState.links,
          days: parsed.days || {},
        };
      }catch(e){
        console.warn("State load failed, using defaults", e);
        return JSON.parse(JSON.stringify(defaultState));
      }
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    function ensureDay(dateStr){
      if(!state.days[dateStr]){
        state.days[dateStr] = {
          scheduleOverride: "",
          notes: "",
          checklist: []
        };
      }else{
        // backfill properties
        state.days[dateStr].scheduleOverride ??= "";
        state.days[dateStr].notes ??= "";
        state.days[dateStr].checklist ??= [];
      }
      return state.days[dateStr];
    }

    /************************************************************
     * DOM
     ************************************************************/
    const ringEl = document.getElementById("ring");
    const ringFrame = document.getElementById("ringFrame");

    const pillTime = document.getElementById("pillTime");
    const pillDow  = document.getElementById("pillDow");
    const clockText= document.getElementById("clockText");
    const dateText = document.getElementById("dateText");

    const viewDateEl = document.getElementById("viewDate");
    const viewDateLabel = document.getElementById("viewDateLabel");
    const checklistSub = document.getElementById("checklistSub");

    const miniScheduleEl = document.getElementById("miniSchedule");
    const nextClassBox = document.getElementById("nextClassBox");
    const nextClassName = document.getElementById("nextClassName");
    const nextClassWhen = document.getElementById("nextClassWhen");
    const untilLine = document.getElementById("untilLine");

    const checkListEl = document.getElementById("checkList");
    const weekTasksEl = document.getElementById("weekTasks");
    const countLine = document.getElementById("countLine");

    const newItemText = document.getElementById("newItemText");
    const addItemBtn = document.getElementById("addItemBtn");
    const clearDoneBtn = document.getElementById("clearDoneBtn");
    const undoBtn = document.getElementById("undoBtn");

    const openDrawerBtn = document.getElementById("openDrawerBtn");
    const closeDrawerBtn = document.getElementById("closeDrawerBtn");
    const drawer = document.getElementById("drawer");
    const saveDayBtn = document.getElementById("saveDayBtn");
    const clearDayBtn = document.getElementById("clearDayBtn");
    const scheduleTextEl = document.getElementById("scheduleText");
    const dayNotesEl = document.getElementById("dayNotes");

    const todayBtn = document.getElementById("todayBtn");

    // tabs
    const tabs = Array.from(document.querySelectorAll(".tab"));
    const panelChecklist = document.getElementById("panelChecklist");
    const panelWeek = document.getElementById("panelWeek");
    const panelSetup = document.getElementById("panelSetup");
    const syncWeekFromScheduleBtn = document.getElementById("syncWeekFromScheduleBtn");

    // setup
    const namedPeriodsEl = document.getElementById("namedPeriods");
    const defaultScheduleEl = document.getElementById("defaultSchedule");
    const saveSetupBtn = document.getElementById("saveSetupBtn");
    const resetSetupBtn = document.getElementById("resetSetupBtn");

    // search
    const googleQuery = document.getElementById("googleQuery");
    const goSearchBtn = document.getElementById("goSearchBtn");

    // context menu
    const editLinksBtn = document.getElementById("editLinksBtn");
    const ctx = document.getElementById("ctxMenu");
    const ctxTitle = document.getElementById("ctxTitle");
    const ctxLabel = document.getElementById("ctxLabel");
    const ctxUrl = document.getElementById("ctxUrl");
    const ctxSave = document.getElementById("ctxSave");
    const ctxDelete = document.getElementById("ctxDelete");
    const ctxCancel = document.getElementById("ctxCancel");
    const ctxAdd = document.getElementById("ctxAdd");
    let ctxTargetId = null;
    let ctxMode = "edit"; // edit | add
    let dragging = null;

    // toast
    const toast = document.getElementById("toast");
    const toastMsg = document.getElementById("toastMsg");
    const toastUndo = document.getElementById("toastUndo");
    const toastClose = document.getElementById("toastClose");
    let undoSnapshot = null;
    let undoTimer = null;

    /************************************************************
     * TOAST + UNDO
     ************************************************************/
    function showToast(message, allowUndo=true){
      toastMsg.textContent = message;
      toast.classList.add("on");
      toastUndo.style.display = allowUndo ? "inline-flex" : "none";
      if (undoTimer) clearTimeout(undoTimer);
      undoTimer = setTimeout(() => {
        toast.classList.remove("on");
        undoSnapshot = null;
        undoTimer = null;
      }, 5200);
    }

    function setUndoSnapshot(){
      undoSnapshot = snapshotState();
    }

    toastClose.addEventListener("click", () => {
      toast.classList.remove("on");
    });

    // (You said: start from sortChecklistStable and keep going.
    //  The lines above are included so this file runs standalone.)
    toastUndo.addEventListener("click", () => {
      if (!undoSnapshot) return;
      state = undoSnapshot;
      saveState();
      hydrateSetupUI();
      viewDateEl.value = state.viewDate;
      renderWeekTasks();
      renderChecklist();
      renderCenterScheduleAndTimers();
      toast.classList.remove("on");
      undoSnapshot = null;
      if (undoTimer) clearTimeout(undoTimer);
      undoTimer = null;
      flashPill("Undone");
    });

    function snapshotState(){
      return JSON.parse(JSON.stringify(state));
    }

    function sortChecklistStable(items){
      const arr = [...items];
      arr.sort((a,b) => {
        const aHasDue = (typeof a.dueAt === "number");
        const bHasDue = (typeof b.dueAt === "number");
        if (aHasDue && bHasDue){
          if (a.dueAt !== b.dueAt) return a.dueAt - b.dueAt;
        } else if (aHasDue && !bHasDue){
          return -1;
        } else if (!aHasDue && bHasDue){
          return 1;
        }

        // priority: 1 (high) before 2 before 3 (default)
        const ap = (typeof a.priority === "number" ? a.priority : 3);
        const bp = (typeof b.priority === "number" ? b.priority : 3);
        if (ap !== bp) return ap - bp;

        // done items drift to bottom
        const ad = !!a.done, bd = !!b.done;
        if (ad !== bd) return ad ? 1 : -1;

        // stable fallback: createdAt then id
        const ac = (typeof a.createdAt === "number" ? a.createdAt : 0);
        const bc = (typeof b.createdAt === "number" ? b.createdAt : 0);
        if (ac !== bc) return ac - bc;

        return String(a.id).localeCompare(String(b.id));
      });
      return arr;
    }

    function flashPill(text){
      const pill = document.getElementById("pillClock");
      pill.classList.remove("flash");
      void pill.offsetWidth;
      pill.classList.add("flash");
      showToast(text, false);
    }

    /************************************************************
     * DATE + TIME HELPERS
     ************************************************************/
    function fmtDow(d){
      return d.toLocaleDateString(undefined, { weekday:"short" });
    }
    function fmtDateLine(d){
      return d.toLocaleDateString(undefined, { weekday:"long", month:"short", day:"numeric", year:"numeric" });
    }
    function parseScheduleLines(rawLines){
      const lines = (rawLines || "").split("\n").map(s => s.trim()).filter(Boolean);
      const parsed = [];
      for (const line of lines){
        // "08:30 | B1" or "08:30 - B1"
        const m = line.split("|").map(s=>s.trim());
        let t, n;
        if (m.length >= 2){
          t = m[0];
          n = m.slice(1).join(" | ");
        }else{
          const m2 = line.split(" - ").map(s=>s.trim());
          if (m2.length >= 2){
            t = m2[0];
            n = m2.slice(1).join(" - ");
          }else{
            t = "";
            n = line;
          }
        }
        parsed.push({ time:t, name:n });
      }
      return parsed;
    }
    function timeToMinutes(hhmm){
      // expects "08:30" 24h
      const m = /^(\d{1,2}):(\d{2})$/.exec((hhmm||"").trim());
      if (!m) return null;
      const h = Number(m[1]);
      const mm = Number(m[2]);
      if (Number.isNaN(h) || Number.isNaN(mm)) return null;
      return h*60 + mm;
    }
    function minutesToHMM(total){
      const h = Math.floor(total/60);
      const m = total%60;
      return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
    }

    function getActiveScheduleForDate(dateStr){
      const day = ensureDay(dateStr);
      const override = (day.scheduleOverride || "").trim();
      const raw = override ? override : (state.defaultScheduleLines || []).join("\n");
      return parseScheduleLines(raw);
    }

    function getNamedSet(){
      return new Set((state.namedPeriods || []).map(s => String(s).trim()).filter(Boolean));
    }

    /************************************************************
     * CENTER RENDER: SCHEDULE + NEXT CLASS TIMER
     ************************************************************/
    function renderCenterScheduleAndTimers(){
      const d = new Date();
      clockText.textContent = d.toLocaleTimeString(undefined, { hour:"2-digit", minute:"2-digit", second:"2-digit" });
      dateText.textContent = fmtDateLine(d);

      const viewDate = state.viewDate;
      viewDateLabel.textContent = viewDate;
      checklistSub.textContent = viewDate;

      const lines = getActiveScheduleForDate(viewDate);
      const named = getNamedSet();

      miniScheduleEl.innerHTML = "";
      for (const s of lines){
        const row = document.createElement("div");
        row.className = "schedLine" + (named.has(s.name) ? " named" : "");
        const t = document.createElement("div");
        t.className = "t";
        t.textContent = s.time || "--:--";
        const n = document.createElement("div");
        n.className = "n";
        n.textContent = s.name || "";
        row.appendChild(t);
        row.appendChild(n);
        miniScheduleEl.appendChild(row);
      }

      // Next class timer: only meaningful if viewing today
      const today = new Date().toISOString().slice(0,10);
      const isToday = (viewDate === today);

      if (!isToday){
        nextClassName.textContent = "Next:";
        nextClassWhen.textContent = "—";
        untilLine.textContent = "Time until next class: (view Today)";
        nextClassBox.classList.remove("hot");
        return;
      }

      const now = new Date();
      const nowMin = now.getHours()*60 + now.getMinutes();

      let next = null;
      for (const s of lines){
        const m = timeToMinutes(s.time);
        if (m === null) continue;
        if (m > nowMin){
          next = { ...s, min:m };
          break;
        }
      }

      if (!next){
        nextClassName.textContent = "Next:";
        nextClassWhen.textContent = "None (day over)";
        untilLine.textContent = "Time until next class: —";
        nextClassBox.classList.remove("hot");
        return;
      }

      const diff = next.min - nowMin;
      const hrs = Math.floor(diff/60);
      const mins = diff%60;

      nextClassName.textContent = "Next:";
      nextClassWhen.textContent = `${next.time} • ${next.name}`;
      untilLine.textContent = `Time until next class: ${hrs ? hrs+"h " : ""}${mins}m`;

      // crackle/hot styling when within 10 minutes
      if (diff <= 10){
        nextClassBox.classList.add("hot");
      }else{
        nextClassBox.classList.remove("hot");
      }
    }

    /************************************************************
     * CHECKLIST
     ************************************************************/
    function getChecklistForView(){
      const day = ensureDay(state.viewDate);
      return day.checklist;
    }

    function setChecklistForView(items){
      const day = ensureDay(state.viewDate);
      day.checklist = items;
    }

    function renderChecklist(){
      const items = sortChecklistStable(getChecklistForView());
      const total = items.length;
      const done = items.filter(i => i.done).length;
      countLine.textContent = `${done}/${total} done`;

      checkListEl.innerHTML = "";
      for (const it of items){
        const card = document.createElement("div");
        card.className = "item";

        const top = document.createElement("div");
        top.className = "itemTop";

        const chk = document.createElement("div");
        chk.className = "chk" + (it.done ? " on" : "");
        chk.innerHTML = `
          <svg width="12" height="12" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 8.5L6.4 12L13 4.8" stroke="rgba(75,255,211,.95)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>`;
        chk.addEventListener("click", () => {
          setUndoSnapshot();
          const arr = getChecklistForView().map(x => x.id === it.id ? ({...x, done: !x.done}) : x);
          setChecklistForView(arr);
          saveState();
          renderChecklist();
          showToast(it.done ? "Marked not done" : "Marked done");
        });

        const txtWrap = document.createElement("div");
        txtWrap.className = "txtWrap";

        const txt = document.createElement("div");
        txt.className = "txt" + (it.done ? " done" : "");
        txt.textContent = it.text || "";
        txtWrap.appendChild(txt);

        const meta = document.createElement("div");
        meta.className = "metaRow";

        // priority chip
        const pri = typeof it.priority === "number" ? it.priority : 3;
        const priChip = document.createElement("div");
        priChip.className = `chip pri${pri}`;
        priChip.innerHTML = `Priority: <b>${pri}</b>`;
        priChip.title = "Click to cycle priority";
        priChip.style.cursor = "pointer";
        priChip.addEventListener("click", () => {
          setUndoSnapshot();
          const nextP = pri === 1 ? 2 : (pri === 2 ? 3 : 1);
          const arr = getChecklistForView().map(x => x.id === it.id ? ({...x, priority: nextP}) : x);
          setChecklistForView(arr);
          saveState();
          renderChecklist();
          showToast(`Priority → ${nextP}`);
        });

        // due chip
        const dueChip = document.createElement("div");
        dueChip.className = "chip due";
        dueChip.title = "Click to set/clear a due time (today)";
        dueChip.style.cursor = "pointer";
        if (typeof it.dueAt === "number"){
          const d = new Date(it.dueAt);
          const hh = d.toLocaleTimeString(undefined, { hour:"2-digit", minute:"2-digit" });
          dueChip.innerHTML = `Due: <b>${hh}</b>`;
          dueChip.classList.add("hot");
        } else {
          dueChip.innerHTML = `Due: <b>—</b>`;
        }
        dueChip.addEventListener("click", () => {
          setUndoSnapshot();
          const cur = (typeof it.dueAt === "number") ? new Date(it.dueAt) : null;
          const guess = cur ? cur.toTimeString().slice(0,5) : "15:30";
          const resp = prompt("Due time (HH:MM, 24h). Leave blank to clear.", guess);
          if (resp === null) return; // cancel
          const val = resp.trim();
          let nextDue = null;
          if (val){
            const mins = timeToMinutes(val);
            if (mins === null){
              showToast("Invalid time. Use HH:MM (24h).", false);
              return;
            }
            // dueAt stored on viewDate
            const dt = new Date(state.viewDate + "T00:00:00");
            dt.setMinutes(mins);
            nextDue = dt.getTime();
          }
          const arr = getChecklistForView().map(x => x.id === it.id ? ({...x, dueAt: nextDue}) : x);
          setChecklistForView(arr);
          saveState();
          renderChecklist();
          showToast(nextDue ? "Due time set" : "Due cleared");
        });

        // note chip
        const noteChip = document.createElement("div");
        noteChip.className = "chip";
        noteChip.title = "Click to edit note";
        noteChip.style.cursor = "pointer";
        const noteText = (it.note || "").trim();
        noteChip.innerHTML = `Note: <b>${noteText ? "yes" : "—"}</b>`;
        noteChip.addEventListener("click", () => {
          setUndoSnapshot();
          const resp = prompt("Note (optional):", it.note || "");
          if (resp === null) return;
          const arr = getChecklistForView().map(x => x.id === it.id ? ({...x, note: resp.trim()}) : x);
          setChecklistForView(arr);
          saveState();
          renderChecklist();
          showToast("Note updated");
        });

        meta.appendChild(priChip);
        meta.appendChild(dueChip);
        meta.appendChild(noteChip);

        // controls row
        const controls = document.createElement("div");
        controls.className = "controls";

        const editBtn = document.createElement("button");
        editBtn.className = "btn ghost";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", () => {
          setUndoSnapshot();
          const resp = prompt("Edit item text:", it.text || "");
          if (resp === null) return;
          const val = resp.trim();
          if (!val){
            showToast("Empty. Use Delete to remove.", false);
            return;
          }
          const arr = getChecklistForView().map(x => x.id === it.id ? ({...x, text: val}) : x);
          setChecklistForView(arr);
          saveState();
          renderChecklist();
          showToast("Item updated");
        });

        const dupBtn = document.createElement("button");
        dupBtn.className = "btn ghost";
        dupBtn.textContent = "Duplicate";
        dupBtn.addEventListener("click", () => {
          setUndoSnapshot();
          const clone = {...it, id: uid(), done:false, createdAt: Date.now()};
          const arr = [...getChecklistForView(), clone];
          setChecklistForView(arr);
          saveState();
          renderChecklist();
          showToast("Duplicated");
        });

        const delBtn = document.createElement("button");
        delBtn.className = "btn danger";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", () => {
          setUndoSnapshot();
          const arr = getChecklistForView().filter(x => x.id !== it.id);
          setChecklistForView(arr);
          saveState();
          renderChecklist();
          showToast("Deleted");
        });

        controls.appendChild(editBtn);
        controls.appendChild(dupBtn);
        controls.appendChild(delBtn);

        top.appendChild(chk);
        top.appendChild(txtWrap);

        card.appendChild(top);
        card.appendChild(meta);
        card.appendChild(controls);

        checkListEl.appendChild(card);
      }
    }

    function addChecklistItem(text){
      const val = (text || "").trim();
      if(!val) return;

      setUndoSnapshot();
      const arr = getChecklistForView();
      arr.push({
        id: uid(),
        text: val,
        done: false,
        priority: 3,
        dueAt: null,
        note: "",
        createdAt: Date.now()
      });
      setChecklistForView(arr);
      saveState();
      renderChecklist();
      showToast("Added");
    }

    addItemBtn.addEventListener("click", () => addChecklistItem(newItemText.value));
    newItemText.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        addChecklistItem(newItemText.value);
        newItemText.value = "";
      }
    });

    clearDoneBtn.addEventListener("click", () => {
      const arr = getChecklistForView();
      const done = arr.filter(i => i.done);
      if (!done.length){
        showToast("No done items to clear.", false);
        return;
      }
      setUndoSnapshot();
      setChecklistForView(arr.filter(i => !i.done));
      saveState();
      renderChecklist();
      showToast("Cleared done");
    });

    undoBtn.addEventListener("click", () => {
      // mirror toast undo
      toastUndo.click();
    });

    /************************************************************
     * WEEK TASKS (simple)
     ************************************************************/
    function startOfWeek(dateStr){
      const d = new Date(dateStr + "T00:00:00");
      const day = d.getDay(); // 0 Sun..6 Sat
      const diff = (day + 6) % 7; // Monday start
      d.setDate(d.getDate() - diff);
      return d;
    }

    function renderWeekTasks(){
      weekTasksEl.innerHTML = "";

      const start = startOfWeek(state.viewDate);
      const blocks = [];

      for(let i=0;i<7;i++){
        const d = new Date(start);
        d.setDate(start.getDate()+i);
        const ds = d.toISOString().slice(0,10);
        const day = ensureDay(ds);
        const sched = getActiveScheduleForDate(ds);
        const preview = sched.slice(0,5).map(x => `${x.time} ${x.name}`).join(" • ");
        blocks.push({ ds, d, day, preview });
      }

      for(const b of blocks){
        const card = document.createElement("div");
        card.className = "item";

        const head = document.createElement("div");
        head.className = "sectionTitle";
        head.style.margin = "0 0 8px";
        head.innerHTML = `<span>${fmtDow(b.d)} • ${b.ds}</span><span class="muted">${(b.day.checklist||[]).length} items</span>`;

        const line = document.createElement("div");
        line.className = "small";
        line.textContent = (b.preview || "No schedule lines.");

        const notes = document.createElement("div");
        notes.className = "small";
        notes.style.marginTop = "8px";
        notes.textContent = b.day.notes ? `Notes: ${b.day.notes}` : "Notes: —";

        const btns = document.createElement("div");
        btns.className = "addRow";
        btns.style.marginTop = "10px";

        const jump = document.createElement("button");
        jump.className = "btn ghost";
        jump.textContent = "View";
        jump.addEventListener("click", () => {
          state.viewDate = b.ds;
          saveState();
          viewDateEl.value = state.viewDate;
          hydrateDrawerUI();
          renderCenterScheduleAndTimers();
          renderChecklist();
          renderWeekTasks();
          flashPill("Viewing " + b.ds);
        });

        const add = document.createElement("button");
        add.className = "btn";
        add.textContent = "Add checklist item";
        add.addEventListener("click", () => {
          const resp = prompt(`Add checklist item for ${b.ds}:`, "");
          if (resp === null) return;
          const val = resp.trim();
          if(!val) return;
          setUndoSnapshot();
          ensureDay(b.ds).checklist.push({
            id: uid(),
            text: val,
            done: false,
            priority: 3,
            dueAt: null,
            note: "",
            createdAt: Date.now()
          });
          saveState();
          renderWeekTasks();
          if (state.viewDate === b.ds) renderChecklist();
          showToast("Added to " + b.ds);
        });

        btns.appendChild(jump);
        btns.appendChild(add);

        card.appendChild(head);
        card.appendChild(line);
        card.appendChild(notes);
        card.appendChild(btns);

        weekTasksEl.appendChild(card);
      }
    }

    syncWeekFromScheduleBtn.addEventListener("click", () => {
      showToast("This button is a placeholder for your future “auto-generate tasks” logic.", false);
    });

    /************************************************************
     * DRAWER (calendar)
     ************************************************************/
    function openDrawer(){
      drawer.classList.add("on");
      hydrateDrawerUI();
    }
    function closeDrawer(){
      drawer.classList.remove("on");
    }

    openDrawerBtn.addEventListener("click", openDrawer);
    closeDrawerBtn.addEventListener("click", closeDrawer);

    function hydrateDrawerUI(){
      viewDateEl.value = state.viewDate;
      const day = ensureDay(state.viewDate);
      scheduleTextEl.value = day.scheduleOverride || "";
      dayNotesEl.value = day.notes || "";
    }

    viewDateEl.addEventListener("change", () => {
      const val = viewDateEl.value;
      if(!val) return;
      state.viewDate = val;
      ensureDay(val);
      saveState();
      hydrateDrawerUI();
      renderCenterScheduleAndTimers();
      renderChecklist();
      renderWeekTasks();
      showToast("Viewing " + val, false);
    });

    saveDayBtn.addEventListener("click", () => {
      setUndoSnapshot();
      const day = ensureDay(state.viewDate);
      day.scheduleOverride = scheduleTextEl.value || "";
      day.notes = dayNotesEl.value || "";
      saveState();
      renderCenterScheduleAndTimers();
      renderWeekTasks();
      showToast("Day saved");
    });

    clearDayBtn.addEventListener("click", () => {
      setUndoSnapshot();
      const day = ensureDay(state.viewDate);
      day.scheduleOverride = "";
      saveState();
      hydrateDrawerUI();
      renderCenterScheduleAndTimers();
      renderWeekTasks();
      showToast("Override cleared");
    });

    todayBtn.addEventListener("click", () => {
      const t = new Date().toISOString().slice(0,10);
      state.viewDate = t;
      ensureDay(t);
      saveState();
      viewDateEl.value = t;
      hydrateDrawerUI();
      renderCenterScheduleAndTimers();
      renderChecklist();
      renderWeekTasks();
      flashPill("Today");
    });

    // Escape closes drawer/context menu
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape"){
        closeDrawer();
        closeCtx();
      }
    });

    /************************************************************
     * SETUP PANEL
     ************************************************************/
    function hydrateSetupUI(){
      namedPeriodsEl.value = (state.namedPeriods || []).join(", ");
      defaultScheduleEl.value = (state.defaultScheduleLines || []).join("\n");
    }

    saveSetupBtn.addEventListener("click", () => {
      setUndoSnapshot();
      const named = namedPeriodsEl.value.split(",").map(s=>s.trim()).filter(Boolean);
      const lines = defaultScheduleEl.value.split("\n").map(s=>s.trim()).filter(Boolean);
      state.namedPeriods = named;
      state.defaultScheduleLines = lines.length ? lines : defaultState.defaultScheduleLines.slice();
      saveState();
      renderCenterScheduleAndTimers();
      renderWeekTasks();
      showToast("Setup saved");
    });

    resetSetupBtn.addEventListener("click", () => {
      setUndoSnapshot();
      state.namedPeriods = defaultState.namedPeriods.slice();
      state.defaultScheduleLines = defaultState.defaultScheduleLines.slice();
      saveState();
      hydrateSetupUI();
      renderCenterScheduleAndTimers();
      renderWeekTasks();
      showToast("Setup reset");
    });

    /************************************************************
     * TABS
     ************************************************************/
    function setTab(which){
      tabs.forEach(t => t.classList.toggle("on", t.dataset.tab === which));
      panelChecklist.style.display = (which === "checklist") ? "" : "none";
      panelWeek.style.display = (which === "week") ? "" : "none";
      panelSetup.style.display = (which === "setup") ? "" : "none";
    }
    tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

    /************************************************************
     * SEARCH
     ************************************************************/
    function doSearch(){
      const q = (googleQuery.value || "").trim();
      if(!q) return;
      const url = "https://www.google.com/search?q=" + encodeURIComponent(q);
      window.open(url, "_blank", "noopener,noreferrer");
    }
    goSearchBtn.addEventListener("click", doSearch);
    googleQuery.addEventListener("keydown", (e) => {
      if(e.key === "Enter") doSearch();
    });

    /************************************************************
     * RING LINKS: LAYOUT + EDIT + REORDER
     ************************************************************/
    function ringNodeSize(n){
      // fewer nodes → larger, more nodes → smaller
      // clamp in a pleasant range
      const size = Math.round(120 - Math.min(60, (n-6)*7));
      return Math.max(58, Math.min(110, size));
    }

    function ringRadius(){
      // based on ring frame size
      const rect = ringFrame.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;
      const min = Math.min(w,h);
      // leave safe margin for node size and center box
      return Math.max(160, Math.floor(min/2 - 86));
    }

    function renderRing(){
      ringEl.innerHTML = "";
      const links = state.links || [];
      const n = links.length;
      const size = ringNodeSize(n);
      const r = ringRadius();

      // center box shrink when too crowded
      const centerW = Math.round(Math.max(220, Math.min(300, 320 - (n-6)*8)));
      const centerH = Math.round(Math.max(200, Math.min(260, 260 - (n-6)*6)));
      document.documentElement.style.setProperty("--centerBoxW", centerW + "px");
      document.documentElement.style.setProperty("--centerBoxH", centerH + "px");

      // position around circle
      for(let i=0;i<n;i++){
        const link = links[i];
        const angle = (Math.PI * 2) * (i / n) - Math.PI/2;
        const x = Math.cos(angle) * r;
        const y = Math.sin(angle) * r;

        const node = document.createElement("div");
        node.className = "node";
        node.dataset.id = link.id;
        node.style.width = size + "px";
        node.style.height = size + "px";
        node.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;

        node.innerHTML = `<div class="label">${escapeHtml(link.label || "Link")}${link.url ? `<span class="sub">${shortHost(link.url)}</span>` : ""}</div>`;

        node.addEventListener("click", (e) => {
          if (state.editLinks){
            // in edit mode, click opens editor (not navigate)
            openCtxFor(link.id, e.clientX, e.clientY);
            return;
          }
          if (link.url) window.open(link.url, "_blank", "noopener,noreferrer");
        });

        node.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          openCtxFor(link.id, e.clientX, e.clientY);
        });

        // drag to reorder when editLinks enabled
        node.addEventListener("pointerdown", (e) => {
          if (!state.editLinks) return;
          dragging = { id: link.id, startX: e.clientX, startY: e.clientY };
          node.setPointerCapture(e.pointerId);
        });

        node.addEventListener("pointermove", (e) => {
          if (!dragging || dragging.id !== link.id) return;
          // find nearest slot by angle
          const rect = ringFrame.getBoundingClientRect();
          const cx = rect.left + rect.width/2;
          const cy = rect.top + rect.height/2;
          const dx = e.clientX - cx;
          const dy = e.clientY - cy;
          const ang = Math.atan2(dy, dx) + Math.PI/2;
          const norm = (ang < 0) ? ang + Math.PI*2 : ang;
          const idx = Math.round((norm / (Math.PI*2)) * n) % n;

          const curIdx = state.links.findIndex(x => x.id === link.id);
          if (idx !== curIdx && idx >= 0){
            setUndoSnapshot();
            const arr = [...state.links];
            const [moved] = arr.splice(curIdx, 1);
            arr.splice(idx, 0, moved);
            state.links = arr;
            saveState();
            renderRing();
          }
        });

        node.addEventListener("pointerup", (e) => {
          if (!dragging) return;
          dragging = null;
        });

        ringEl.appendChild(node);
      }
    }

    function shortHost(url){
      try{
        const u = new URL(url);
        return u.host.replace(/^www\./,"");
      }catch(e){
        return "";
      }
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function openCtxFor(id, x, y){
      ctxTargetId = id;
      ctxMode = "edit";
      const link = state.links.find(l => l.id === id);
      ctxTitle.textContent = "Edit link";
      ctxLabel.value = link?.label || "";
      ctxUrl.value = link?.url || "";
      ctxDelete.style.display = "";
      ctxAdd.textContent = "Add new";
      positionCtx(x,y);
      ctx.classList.add("on");
    }

    function openCtxAdd(x, y){
      ctxTargetId = null;
      ctxMode = "add";
      ctxTitle.textContent = "Add link";
      ctxLabel.value = "";
      ctxUrl.value = "";
      ctxDelete.style.display = "none";
      ctxAdd.textContent = "Add";
      positionCtx(x,y);
      ctx.classList.add("on");
    }

    function positionCtx(x,y){
      const pad = 14;
      const w = 260;
      const h = 240;
      let left = x + 10;
      let top = y + 10;
      if (left + w > window.innerWidth - pad) left = window.innerWidth - w - pad;
      if (top + h > window.innerHeight - pad) top = window.innerHeight - h - pad;
      ctx.style.left = left + "px";
      ctx.style.top = top + "px";
    }

    function closeCtx(){
      ctx.classList.remove("on");
      ctxTargetId = null;
      ctxMode = "edit";
    }

    ctxCancel.addEventListener("click", closeCtx);

    ctxSave.addEventListener("click", () => {
      const label = ctxLabel.value.trim();
      const url = ctxUrl.value.trim();
      if (ctxMode === "add"){
        if(!label || !url){
          showToast("Label + URL required.", false);
          return;
        }
        setUndoSnapshot();
        state.links.push({ id: uid(), label, url });
        saveState();
        renderRing();
        closeCtx();
        showToast("Link added");
        return;
      }

      if(!ctxTargetId) return;
      setUndoSnapshot();
      state.links = state.links.map(l => l.id === ctxTargetId ? ({...l, label: label || "Link", url}) : l);
      saveState();
      renderRing();
      closeCtx();
      showToast("Link saved");
    });

    ctxDelete.addEventListener("click", () => {
      if(!ctxTargetId) return;
      if(!confirm("Delete this link?")) return;
      setUndoSnapshot();
      state.links = state.links.filter(l => l.id !== ctxTargetId);
      saveState();
      renderRing();
      closeCtx();
      showToast("Link deleted");
    });

    ctxAdd.addEventListener("click", (e) => {
      if (ctxMode === "add"){
        ctxSave.click();
      }else{
        // open add mode near menu
        const rect = ctx.getBoundingClientRect();
        openCtxAdd(rect.left + 20, rect.top + 20);
      }
    });

    editLinksBtn.addEventListener("click", () => {
      state.editLinks = !state.editLinks;
      saveState();
      editLinksBtn.textContent = state.editLinks ? "Done Editing" : "Edit Links";
      flashPill(state.editLinks ? "Edit mode" : "Locked");
      if (state.editLinks){
        const rect = ringFrame.getBoundingClientRect();
        openCtxAdd(rect.left + rect.width - 60, rect.top + 60);
      }else{
        closeCtx();
      }
    });

    window.addEventListener("click", (e) => {
      // close ctx if click outside
      if (ctx.classList.contains("on")){
        const inside = ctx.contains(e.target);
        if (!inside) closeCtx();
      }
    }, true);

    window.addEventListener("resize", () => {
      renderRing();
      renderCenterScheduleAndTimers();
    });

    /************************************************************
     * FX: STARFIELD + ELECTRIC ARCS
     ************************************************************/
    const stars = document.getElementById("stars");
    const arcs = document.getElementById("arcs");
    const sctx = stars.getContext("2d");
    const actx = arcs.getContext("2d");
    let fxRunning = true;

    function resizeFx(){
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const w = window.innerWidth;
      const h = window.innerHeight;
      stars.width = Math.floor(w*dpr);
      stars.height= Math.floor(h*dpr);
      stars.style.width = w+"px";
      stars.style.height= h+"px";

      arcs.width = Math.floor(w*dpr);
      arcs.height= Math.floor(h*dpr);
      arcs.style.width = w+"px";
      arcs.style.height= h+"px";

      sctx.setTransform(dpr,0,0,dpr,0,0);
      actx.setTransform(dpr,0,0,dpr,0,0);

      // init stars
      starField = makeStars(180, w, h);
    }

    function makeStars(n,w,h){
      const arr = [];
      for(let i=0;i<n;i++){
        arr.push({
          x: Math.random()*w,
          y: Math.random()*h,
          z: 0.3 + Math.random()*0.9,
          r: 0.4 + Math.random()*1.6,
          tw: Math.random()*Math.PI*2
        });
      }
      return arr;
    }

    let starField = [];
    let lastFx = 0;

    function drawFx(ts){
      if (!fxRunning){ lastFx = ts; requestAnimationFrame(drawFx); return; }
      const dt = Math.min(50, ts - lastFx);
      lastFx = ts;

      const w = window.innerWidth;
      const h = window.innerHeight;

      // starfield
      sctx.clearRect(0,0,w,h);
      for(const s of starField){
        s.x -= 0.02 * dt * s.z;
        s.y += 0.01 * dt * s.z;
        if (s.x < -10) s.x = w+10;
        if (s.y > h+10) s.y = -10;
        s.tw += 0.002*dt*(0.7+s.z);

        const a = 0.22 + 0.30*(0.5+0.5*Math.sin(s.tw));
        sctx.beginPath();
        sctx.fillStyle = `rgba(234,240,255,${a*s.z})`;
        sctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        sctx.fill();
      }

      // arcs (occasional crackle)
      actx.clearRect(0,0,w,h);

      // very occasional: arcs around ringFrame border + search bar
      if (Math.random() < 0.04){
        crackleRect(actx, ringFrame.getBoundingClientRect(), 2 + Math.random()*2);
      }
      if (Math.random() < 0.025){
        const sr = document.querySelector(".search").getBoundingClientRect();
        crackleRect(actx, sr, 1.6 + Math.random()*1.6);
      }
      if (Math.random() < 0.02){
        const lr = document.querySelector(".left").getBoundingClientRect();
        crackleEdge(actx, lr, "bottom");
      }
      // if next class is soon: more arcs on the nextClass box
      const hot = nextClassBox.classList.contains("hot");
      if (hot && Math.random() < 0.10){
        crackleRect(actx, nextClassBox.getBoundingClientRect(), 1.8 + Math.random()*1.8);
      }

      requestAnimationFrame(drawFx);
    }

    function crackleRect(ctx, rect, intensity=2){
      const pad = 6;
      const x = rect.left - pad;
      const y = rect.top - pad;
      const w = rect.width + pad*2;
      const h = rect.height + pad*2;
      // choose a random edge segment
      const edge = ["top","right","bottom","left"][Math.floor(Math.random()*4)];
      const points = [];
      const steps = 10 + Math.floor(Math.random()*10);
      for(let i=0;i<=steps;i++){
        const t = i/steps;
        if(edge==="top")    points.push({x:x + t*w, y:y + jitter(2)});
        if(edge==="bottom") points.push({x:x + t*w, y:y + h + jitter(2)});
        if(edge==="left")   points.push({x:x + jitter(2), y:y + t*h});
        if(edge==="right")  points.push({x:x + w + jitter(2), y:y + t*h});
      }
      drawBolt(ctx, points, intensity);
    }

    function crackleEdge(ctx, rect, which="bottom"){
      const pad = 0;
      const x = rect.left - pad;
      const y = rect.top - pad;
      const w = rect.width + pad*2;
      const h = rect.height + pad*2;
      const steps = 14 + Math.floor(Math.random()*10);
      const points = [];
      for(let i=0;i<=steps;i++){
        const t = i/steps;
        if(which==="bottom") points.push({x:x + t*w, y:y + h + jitter(3)});
        if(which==="top")    points.push({x:x + t*w, y:y + jitter(3)});
      }
      drawBolt(ctx, points, 2.2);
    }

    function drawBolt(ctx, pts, intensity){
      ctx.save();
      ctx.lineWidth = 1.2;
      ctx.globalCompositeOperation = "screen";

      // glow layer
      ctx.beginPath();
      ctx.strokeStyle = `rgba(123,231,255,${0.25*intensity})`;
      ctx.lineWidth = 3.2;
      ctx.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++){
        ctx.lineTo(pts[i].x + jitter(2), pts[i].y + jitter(2));
      }
      ctx.stroke();

      // core
      ctx.beginPath();
      ctx.strokeStyle = `rgba(45,125,255,${0.35*intensity})`;
      ctx.lineWidth = 1.4;
      ctx.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++){
        ctx.lineTo(pts[i].x + jitter(1.5), pts[i].y + jitter(1.5));
      }
      ctx.stroke();

      ctx.restore();
    }

    function jitter(px){
      return (Math.random()*2 - 1) * px;
    }

    // Pause animations when not visible
    document.addEventListener("visibilitychange", () => {
      fxRunning = !document.hidden;
    });

    /************************************************************
     * BOOT
     ************************************************************/
    function tickClock(){
      const d = new Date();
      pillTime.textContent = d.toLocaleTimeString(undefined, { hour:"2-digit", minute:"2-digit" });
      pillDow.textContent = fmtDow(d);
      renderCenterScheduleAndTimers();
    }

    function boot(){
      hydrateSetupUI();
      ensureDay(state.viewDate);
      viewDateEl.value = state.viewDate;
      hydrateDrawerUI();

      editLinksBtn.textContent = state.editLinks ? "Done Editing" : "Edit Links";

      renderRing();
      renderChecklist();
      renderWeekTasks();
      renderCenterScheduleAndTimers();

      // clock tick
      tickClock();
      setInterval(tickClock, 1000);

      // fx
      resizeFx();
      window.addEventListener("resize", resizeFx);
      requestAnimationFrame(drawFx);
    }

    boot();
  </script>
</body>
</html>
